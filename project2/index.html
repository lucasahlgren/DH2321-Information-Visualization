<!DOCTYPE html>
<meta charset="utf-8" />
<head>
	<title>Project 2 | World Values Survey Visualization</title>

	<!-- Load styles and icons -->
	<link rel="shortcut icon" type="image/png" href="assets/shortcut_logo.png" />
	<link
		rel="stylesheet"
		href="https://fonts.googleapis.com/icon?family=Material+Icons"
	/>

	<link
		rel="stylesheet"
		href="assets/bootstrap.min.css"
		integrity="sha384-PDle/QlgIONtM1aqA2Qemk5gPOE7wFq8+Em+G/hmo5Iq0CCmYZLv3fVRDJ4MMwEA"
		crossorigin="anonymous"
	/>

	<link
		href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.7.1/css/mdb.min.css"
		rel="stylesheet"
	/>

	<link rel="stylesheet" href="style.css" />
</head>
<!-- Visualization based on a map example by Mike Bostock https://bl.ocks.org/mbostock/eec4a6cda2f573574a11 -->
<body>
	<div class="container-fluid bg">
		<div class="app p-4">
			<div class="row">
				<div class="col-12">
					<!-- Header -->
					<h2 class="header text-center p-3 mb-3">
						Project 2 - World values survey
						<button
							class="btn btn-sm btn-light ml-4 menu-btn"
							data-toggle="modal"
							data-target=".info-modal"
						>
							Info
						</button>
						<!--	<img
							class="info ml-2"
							src="assets/info.png"
							alt="Information button"
							data-toggle="modal"
							data-target=".info-modal"
						/>-->
						<button
							class="btn btn-sm btn-light menu-btn"
							data-toggle="modal"
							data-target=".discovery-modal"
						>
							Discovery process
						</button>
					</h2>
				</div>
			</div>

			<!-- Info modal -->
			<div
				class="modal fade info-modal"
				tabindex="-1"
				role="dialog"
				aria-labelledby="myLargeModalLabel"
				aria-hidden="true"
			>
				<div class="modal-dialog modal-lg" role="document">
					<div class="modal-content p-3">
						<div class="modal-header">
							<h3 class="modal-title">World values survey visualization</h3>
							<button
								class="btn-sm btn-light btn"
								type="button"
								data-dismiss="modal"
								aria-label="Close"
							>
								<span aria-hidden="true">X</span>
							</button>
						</div>
						<div class="modal-body">
							<p>
								This is a world values survey visualization including data from
								gapminder. Here you can learn more about what people think is
								important in life as well as the state of health, if they feel
								happy and the average life expectancy. Click on a country to
								learn more about it. You can also zoom and pan on the map to
								easily find the country you want.
							</p>
							<div class="container mx-auto py-4">
								<img class="mx-auto row col-6" src="assets/gapminder.png" />
								<img class="mx-auto row col-6" src="assets/wvs2.png" />
							</div>
							<p>
								Besides average life expectancy (years) each category presents
								the number of percent of people who thinks the category is very
								important or rather important when it comes to work, politics,
								religion, leisure time and friends. For happiness, the number of
								percents corresponds to people who answered that they feel very
								happy or quite happy. For the state of health, the number of
								percents corresponds to people who answered that their state of
								health is very good or good. Each category is encoded with the
								colors down below. A stronger color corresponds to a higher
								percentage. The color scale goes from the lowest percentage of
								all countries in that category over the 20 years to the highest percentage of all
								countries. This helps to differentiate countries from another
								and makes it easier to see which country is the worst and which is the best within that category.
							</p>
							<ul>
								<li>
									Life expectancy -
									<span
										class="dot"
										style=" background-color: rgba(2, 100, 160,1)"
									></span>
								</li>
								<li>
									Work -
									<span
										class="dot"
										style=" background-color: rgba(255, 50, 160,1)"
									></span>
								</li>
								<li>
									Politics -
									<span
										class="dot"
										style=" background-color: rgba(70, 70, 70,1)"
									></span>
								</li>
								<li>
									Family -
									<span
										class="dot"
										style=" background-color: rgba(100, 70, 50,1)"
									></span>
								</li>
								<li>
									Religion -
									<span
										class="dot"
										style=" background-color: rgba(50, 120, 120,1)"
									></span>
								</li>
								<li>
									Happiness -
									<span
										class="dot"
										style=" background-color: rgba(170, 170, 20,1)"
									></span>
								</li>
								<li>
									State of health -
									<span
										class="dot"
										style=" background-color: rgba(2, 150, 50,1)"
									></span>
								</li>
								<li>
									Leisure time -
									<span
										class="dot"
										style=" background-color: rgba(150, 0, 150,1)"
									></span>
								</li>
								<li>
									Friends -
									<span
										class="dot"
										style=" background-color:rgba(255, 50, 80,1)"
									></span>
								</li>
							</ul>
							<p>
								The visualization is based on a map example by Mike Bostock
								which can be found
								<a href="https://bl.ocks.org/mbostock/eec4a6cda2f573574a11"
									>here</a
								>.
							</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Discovery modal -->
			<div
				class="modal fade discovery-modal"
				tabindex="-1"
				role="dialog"
				aria-labelledby="myLargeModalLabel"
				aria-hidden="true"
			>
				<div class="modal-dialog modal-lg" role="document">
					<div class="modal-content p-3">
						<div class="modal-header">
							<h3 class="modal-title">Discovery process</h3>
							<button
								class="btn-sm btn-light btn"
								type="button"
								data-dismiss="modal"
								aria-label="Close"
							>
								<span aria-hidden="true">X</span>
							</button>
						</div>
						<div class="modal-body">
							<h4>World values survey</h4>
							<p>
								First I had to select all the countries I wanted to include.
							</p>
							<br />
							<h4>Project 2 visualization</h4>
							<p>
								With my visualization you don't have to select all the countries
								you want, they are all there. It is easy to select a specific
								topic/question and get immediate response about the country
								because of preattentive features such as color and position.
							</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Visualization container -->
			<div class="row justify-content-center mb-3">
				<!-- Map container -->
				<div class="col-7">
					<div id="container" class="mx-auto"></div>
				</div>

				<!-- Country container -->
				<div class="col-4">
					<div id="countryInfo" class="card">
						<div id="countryHeader" class="p-2 pt-3">
							<h3 id="introHeader" class="pb-2 m-2 mt-2 text-center">
								Welcome!
							</h3>
							<p id="introText" class="pr-3 pl-3 pb-2 text-left">
								This is a world values survey + gapminder visualization. Here
								you can learn more about what people think is important in life.
								If you are interested in what kind of data you can click the
								info button above to read more. Click on a country to learn more
								about it. You can also zoom and pan on the map to easily find
								the country you want.
							</p>
						</div>
						<div class="row mx-auto">
							<div id="countryChart" class="mx-auto p-3">
								<div class="col-8 mx-auto p-2">
									<img class="col-12 pb-2" src="assets/gapminder.png" />
									<img class="col-12 p-0 " src="assets/wvs2.png" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id="chart"></div>
			</div>

			<!-- Filter container -->
			<div class="row">
				<div class="mx-auto">
					<button
						type="button"
						onclick="switchWave('wave1')"
						id="wave1"
						class="wave1 btn btn-light btn-style"
					>
						1995-1999
					</button>
					<button
						onclick="switchWave('wave2')"
						id="wave2"
						class="btn btn-light btn-style"
					>
						2000-2004
					</button>
					<button
						onclick="switchWave('wave3')"
						id="wave3"
						class="btn btn-light btn-style"
					>
						2005-2009
					</button>
					<button
						onclick="switchWave('wave4')"
						id="wave4"
						class="btn btn-light btn-style"
					>
						2010-2014
					</button>

					<!--Dropdown primary-->
					<!--Trigger-->
					<button
						class="btn dropdown-toggle dropdown-title ml-5"
						type="button"
						id="dropdownMenu1"
						data-toggle="dropdown"
						aria-haspopup="true"
						aria-expanded="false"
					>
						Active
					</button>

					<!--Menu-->
					<div class="dropdown-menu dropdown-primary">
						<a class="dropdown-item" onclick="updateCategory('life')"
							>Life expectancy</a
						>
						<a class="dropdown-item" onclick="updateCategory('work')"
							>Work is important</a
						>
						<a class="dropdown-item" onclick="updateCategory('family')"
							>Family is important</a
						>
						<a class="dropdown-item" onclick="updateCategory('religion')"
							>Religion is important</a
						>
						<a class="dropdown-item" onclick="updateCategory('politics')"
							>Politics is important</a
						>
						<a class="dropdown-item" onclick="updateCategory('leisure')"
							>Leisure time is important</a
						>
						<a class="dropdown-item" onclick="updateCategory('friends')"
							>Friends is important</a
						>
						<a class="dropdown-item" onclick="updateCategory('health')"
							>State of health</a
						>
						<a class="dropdown-item" onclick="updateCategory('happiness')"
							>Happiness</a
						>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Load scripts: jquery, bootstrap, mdbootstrap, topojson, d3 -->
	<script
		src="assets/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
		crossorigin="anonymous"
	></script>
	<script
		src="assets/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"
	></script>
	<script
		src="assets/bootstrap.min.js"
		integrity="sha384-7aThvCh9TypR7fIc2HV4O/nFMVCBwyIUKL8XCtKE+8xgCgl/PQGuFsvShjr74PBp"
		crossorigin="anonymous"
	></script>
	<script defer src="assets/material.min.js"></script>
	<script src="assets/d3.v3.min.js"></script>
	<script src="assets/topojson.v1.min.js"></script>
	<script src="assets/d3-queue.v3.min.js"></script>

	<!-- Visualization script -->
	<script>
		var questions = {
			life: "Life expectancy",
			work: "Work is important",
			friends: "Friends is important",
			religion: "Religion is important",
			happiness: "Happiness",
			health: "State of health",
			politics: "Politics is important",
			leisure: "Leisure time is important",
			family: "Family is important"
		};

		var questionColor = {
			life: ["rgba(2, 100, 160,.1)", "rgba(2, 100, 160,1)"],
			work: ["rgba(255, 50, 160,.1)", "rgba(255, 50, 160,1)"],
			friends: ["rgba(255, 50, 80,.1)", "rgba(255, 50, 80,1)"],
			religion: ["rgba(50, 120, 120,.1)", "rgba(50, 120, 120,1)"],
			happiness: ["rgba(170, 170, 20,.1)", "rgba(170, 170, 20,1)"],
			health: ["rgba(2, 150, 50,.1)", "rgba(2, 150, 50,1)"],
			politics: ["rgba(70, 70, 70,.1)", "rgba(70, 70, 70,1)"],
			leisure: ["rgba(150, 0, 150,.1)", "rgba(150, 0, 150,1)"],
			family: ["rgba(100, 70, 50,.1)", "rgba(100, 70, 50,1)"]
		};

		addEventListener("resize", function() {
			width = window.innerWidth * 0.6;
			height = window.innerHeight * 0.65;
		});

		// Global variables
		var width = window.innerWidth * 0.6,
			height = window.innerHeight * 0.65,
			centered,
			world_id,
			life_expectancy,
			currentWave = "wave1",
			currentCountry = null,
			currentCategory = "life";

		// Change category button style on load
		$(".dropdown-title")
			.attr("style", "background-color: " + questionColor[currentCategory][1])
			.text(questions[currentCategory]);

		var tooltip = d3
			.select("#container")
			.append("div")
			.attr("class", "tooltip hidden");

		var projection = d3.geo
			.mercator()
			.scale(120)
			.translate([width / 2.1, height / 1.5]);

		var path = d3.geo.path().projection(projection);

		var zoom = d3.behavior
			.zoom()
			.translate(projection.translate())
			.scale(projection.scale())
			.scaleExtent([height * 0.27, 3 * height])
			.on("zoom", zoomed);

		var svg = d3
			.select("#container")
			.append("svg")
			.attr("width", width)
			.attr("class", "map card shadow")
			.attr("height", height);

		var g = svg.append("g").call(zoom);

		g.append("rect")
			.attr("class", "background")
			.attr("width", width)
			.attr("height", height);

		// Create map
		d3.queue()
			.defer(d3.json, "world-110m.v1.json")
			.defer(d3.json, "data_final.json")
			.await(
				function(error, world, data) {
					if (error) throw error;

					// Put data into variables
					world_id = data;

					//console.log("READING DATA");
					//console.log(world_id);

					var updatedColorScale = updateColorScale();

					// Custom legend

					var legend = d3
						.select(".map")
						.append("svg")
						.attr("height", 200)
						.attr("id", "legend")
						.attr("width", 300)
						.append("g")


					if (currentCategory == "life") {
						var unit = " years";
					} else {
						var unit = " %";
					}

					legend
						.append("rect")
						.attr("x", 0)

						.attr("transform", "translate(15,10)")
						.attr("y", 0)
						.attr("width", parseInt(255+unit.length*7))
						.attr("height", 50)
						.style("fill", "white");

					legend
						.append("rect")
						.attr("x", 0)

						.attr("transform", "translate(40,25)")
						.attr("y", 0)
						.attr("width", 20)
						.attr("height", 20)
						.style("fill", questionColor[currentCategory][0]);

					legend
						.append("text")
						.attr("transform", "translate(65,38)")
						.text(updatedColorScale[0] + unit);

					legend
						.append("rect")
						.attr("x", 0)
						.attr(
							"transform",
							"translate(" + parseInt(105 + unit.length * 3) + ",25)"
						)
						.attr("y", 0)
						.attr("width", 20)
						.attr("height", 20)
						.style("fill", questionColor[currentCategory][1]);

					legend
						.append("text")
						.attr(
							"transform",
							"translate(" + parseInt(130 + unit.length * 3) + ", 39)"
						)
						.text(updatedColorScale[1] + unit);

					legend
						.append("rect")
						.attr("x", 0)
						.attr(
							"transform",
							"translate(" + parseInt(175 + unit.length * 5) + ",25)"
						)
						.attr("y", 0)
						.attr("width", 20)
						.attr("height", 20)
						.style("fill", "black");

					legend
						.append("text")
						.attr(
							"transform",
							"translate(" + parseInt(200 + unit.length * 5) + ", 39)"
						)
						.text("No data");

					var colorScale = d3.scale
						.linear()
						.domain(updatedColorScale)
						.range(questionColor[currentCategory]);

					//console.log(d3.extent(newArray, function(d){if(d[currentWave] != null){return parseInt(d[currentWave].life)}}))

					//console.log(colorScale(parseInt(newArray[11][currentWave].life)))

					var rawCountries = topojson.feature(world, world.objects.countries)
							.features,
						neighbors = topojson.neighbors(world.objects.countries.geometries);

					//console.log(rawCountries);
					//console.log(neighbors);
					var countries = [];

					// Splice(remove) random pieces
					rawCountries.splice(145, 1);
					rawCountries.splice(38, 1);

					rawCountries.map(country => {
						//console.log(parseInt(country.id) !== 010)
						// Filter out Antartica and Kosovo
						if (parseInt(country.id) !== parseInt("010")) {
							countries.push(country);
						} else {
							//console.log(country.id);
						}
					});

					//console.log(countries);

					g.append("g")
						.attr("id", "countries")
						.selectAll(".country")
						.data(countries)
						.enter()
						.insert("path", ".graticule")
						.attr("class", "country")
						.attr("d", path)
						.attr("fill", function(d) {
							//console.log(d)

							var countryFill = world_id.filter(
								country => String(country.id) == String(d.id)
							);
							//console.log(countryFill)
							if (countryFill[0][currentWave] != null) {
								return colorScale(
									parseInt(countryFill[0][currentWave][currentCategory])
								);
							} else {
								return "rgba(0,0,0,1)";
							}
						})
						.attr("data-name", function(d) {
							return d.id;
						})
						.on("click", clicked)
						.on("mousemove", function(d, i) {
							var mouse = d3.mouse(svg.node()).map(function(d) {
								return parseInt(d);
							});

							tooltip
								.classed("hidden", false)
								.attr(
									"style",
									"left:" + mouse[0] + "px;top:" + (mouse[1] - 50) + "px"
								)
								.html(getCountryName(d.id));
						})
						.on("mouseout", function(d, i) {
							tooltip.classed("hidden", true);
						});
				},

				// Add color to wave button
				$("#" + currentWave).addClass("wave-active")
			);

		// Update color scale when changing category and on load
		function updateColorScale() {
			var wave1 = d3.extent(world_id, function(d) {
				if (d["wave1"] != null) {
					return parseInt(d["wave1"][currentCategory]);
				}
			});

			var wave2 = d3.extent(world_id, function(d) {
				if (d["wave2"] != null) {
					return parseInt(d["wave2"][currentCategory]);
				}
			});

			var wave3 = d3.extent(world_id, function(d) {
				if (d["wave3"] != null) {
					return parseInt(d["wave3"][currentCategory]);
				}
			});

			var wave4 = d3.extent(world_id, function(d) {
				if (d["wave4"] != null) {
					return parseInt(d["wave4"][currentCategory]);
				}
			});

			var waves = [wave1, wave2, wave3, wave4];

			var minVal = null;
			var maxVal = null;
			var max;
			var min;
			for (var i = 0; i < waves.length; i++) {
				max = Math.max.apply(null, waves[i]);
				min = Math.min.apply(null, waves[i]);
				if (max > maxVal || maxVal == null) {
					maxVal = max;
				}
				if (min < minVal || minVal == null) {
					minVal = min;
				}
			}
			//console.log(minVal);
			//console.log(maxVal);
			return (colorScale = [minVal, maxVal]);
		}

		// Update visualization when changing wave
		function update() {
			var updatedColorScale = updateColorScale();

			var colorScale = d3.scale
				.linear()
				.domain(updatedColorScale)
				.range(questionColor[currentCategory]);

			d3.select("#container")
				.selectAll("path")
				.transition()
				.duration(300)
				.attr("fill", function(d) {
					//console.log(d)

					var countryFill = world_id.filter(
						country => String(country.id) == String(d.id)
					);
					//console.log(countryFill)
					if (countryFill[0][currentWave] != null) {
						return colorScale(
							parseInt(countryFill[0][currentWave][currentCategory])
						);
					} else {
						return "rgba(0,0,0,1)";
					}
				});
		}

		// Update visualization when changing category
		function updateCategoryColor() {
			var updatedColorScale = updateColorScale();

		// Custom legend

		d3.select("#legend").selectAll("*").remove();
		var legend = d3.select("#legend").append("g");
				
				
				
				var unit;
				if (currentCategory == "life") {
					unit = " years";
				} else {
					unit = " %";
				}

				legend
					.append("rect")
					.attr("x", 0)

					.attr("transform", "translate(15,10)")
					.attr("y", 0)
					.attr("width", parseInt(255+unit.length*7))
					.attr("height", 50)
					.style("fill", "white");

				legend
					.append("rect")
					.attr("x", 0)

					.attr("transform", "translate(40,25)")
					.attr("y", 0)
					.attr("width", 20)
					.attr("height", 20)
					.style("fill", questionColor[currentCategory][0]);

				legend
					.append("text")
					.attr("transform", "translate(65,38)")
					.text(updatedColorScale[0] + unit);

				legend
					.append("rect")
					.attr("x", 0)
					.attr(
						"transform",
						"translate(" + parseInt(105 + unit.length * 3) + ",25)"
					)
					.attr("y", 0)
					.attr("width", 20)
					.attr("height", 20)
					.style("fill", questionColor[currentCategory][1]);

				legend
					.append("text")
					.attr(
						"transform",
						"translate(" + parseInt(130 + unit.length * 3) + ", 38)"
					)
					.text(updatedColorScale[1] + unit);

				legend
					.append("rect")
					.attr("x", 0)
					.attr(
						"transform",
						"translate(" + parseInt(175 + unit.length * 5) + ",25)"
					)
					.attr("y", 0)
					.attr("width", 20)
					.attr("height", 20)
					.style("fill", "black");

				legend
					.append("text")
					.attr(
						"transform",
						"translate(" + parseInt(200 + unit.length * 5) + ", 39)"
					)
					.text("No data");



			var colorScale = d3.scale
				.linear()
				.domain(updatedColorScale)
				.range(questionColor[currentCategory]);

			d3.select("#container")
				.selectAll("path")
				.attr("fill", function(d) {
					//console.log(d)

					var countryFill = world_id.filter(
						country => String(country.id) == String(d.id)
					);
					//console.log(countryFill)
					if (countryFill[0][currentWave] != null) {
						return colorScale(
							parseInt(countryFill[0][currentWave][currentCategory])
						);
					} else {
						return "rgba(0,0,0,1)";
					}
				});
		}

		// Update to new category
		function updateCategory(category) {
			currentCategory = category.toLowerCase();

			$(".dropdown-title")
				.attr("style", "background-color: " + questionColor[currentCategory][1])
				.text(questions[currentCategory]);

			// Update button title
			updateCategoryColor();
		}

		// Change wave
		function switchWave(wave) {
			//console.log(currentWave);
			$("#" + currentWave).removeClass("wave-active");
			$("#" + wave).addClass("wave-active");

			currentWave = wave;
			console.log(currentWave);
			update();
			if (currentCountry != null) {
				updateCountry(currentCountry);
				//console.log(currentCountry);
			}
		}

		// Get country name from id
		function getCountryName(id) {
			var country = world_id.filter(
				country => parseInt(country.id) == parseInt(id)
			);
			//console.log(country[0].name);
			//console.log(id);
			return country[0].name;
		}

		function drawBarChart(country) {
		
			//console.log(country);

			var dataset = [];
			var categories = [];

			for (var key in country[currentWave]) {
				//console.log(hej);
				var key = key;
				//console.log(name);
				categories.push(key);
			}
			//	console.log(categories);

			for (var i = 0; i < categories.length; i++) {
				var category;
				//console.log(categories[i]);
				category = categories[i];
				var json = {};
				if (category != "life") {
					var category = category[0].toUpperCase() + category.substring(1);
					json["name"] = category;
					json["data"] = parseInt(country[currentWave][categories[i]]);
					dataset.push(json);
				}
			}

			//console.log(dataset);

			// Dimensions for the chart: height, width, and space b/t the bars
			var margins = { top: 20, right: 20, bottom: 50, left: 50 };
			var height = window.innerHeight * 0.3 - margins.left - margins.right,
				width = window.innerWidth * 0.25 - margins.top - margins.bottom,
				barPadding = 5;

			// Create a scale for the y-axis based on data
			// >> Domain - min and max values in the dataset
			// >> Range - physical range of the scale (reversed)
			var yScale = d3.scale
				.linear()
				.domain([
					0,
					d3.max(dataset, function(d) {
						return d.data;
					})
				])
				.range([height, 0])
				.nice();

			// Implements the scale as an actual axis
			// >> Orient - places the axis on the left of the graph
			// >> Ticks - number of points on the axis, automated
			var yAxis = d3.svg
				.axis()
				.scale(yScale)
				.orient("left")
				.ticks(5);

			// Creates a scale for the x-axis based on city names
			var xScale = d3.scale
				.ordinal()
				.domain(
					dataset.map(function(d) {
						return d.name;
					})
				)
				.rangeRoundBands([0, width], 0.1);

			// Creates an axis based off the xScale properties
			var xAxis = d3.svg
				.axis()
				.scale(xScale)
				.orient("bottom");

			// Creates the initial space for the chart
			// >> Select - grabs the empty <div> above this script
			// >> Append - places an <svg> wrapper inside the div
			// >> Attr - applies our height & width values from above
			var chart = d3
				.select("#countryChart")
				.append("svg")
				.attr("class", "bar-chart")
				.attr("width", width + margins.left + margins.right)
				.attr("height", height + margins.top + margins.bottom)
				.append("g")
				.attr(
					"transform",
					"translate(" + margins.left + "," + margins.top + ")"
				);

			// For each value in our dataset, places and styles a bar on the chart

			// Step 1: selectAll.data.enter.append
			// >> Loops through the dataset and appends a rectangle for each value
			chart
				.selectAll("rect")
				.data(dataset)
				.enter()
				.append("rect")

				// Step 2: X & Y
				// >> X - Places the bars in horizontal order, based on number of
				//        points & the width of the chart
				// >> Y - Places vertically based on scale
				.attr("x", function(d, i) {
					return xScale(d.name);
				})
				.attr("y", function(d) {
					return yScale(d.data);
				})

				// Step 3: Height & Width
				// >> Width - Based on barpadding and number of points in dataset
				// >> Height - Scale and height of the chart area
				.attr("width", width / dataset.length - barPadding)
				.attr("height", function(d) {
					return height - yScale(d.data);
				})
				.attr("fill", function(d) {
					return questionColor[d.name.toLowerCase()][1];
				})
				.on("mousemove", function(d, i) {
					var mouse = d3.mouse(svg.node()).map(function(d) {
						return parseInt(d);
					});

					tooltip
						.classed("hidden", false)
						.attr(
							"style",
							"left:" + mouse[0] + "px;top:" + (mouse[1] - 50) + "px"
						)
						.html(d.data + "%");
				})
				.on("mouseout", function(d, i) {
					tooltip.classed("hidden", true);
				})
				.on("click", function(d) {
					updateCategory(d.name);
				});

			// Renders the yAxis once the chart is finished
			// >> Moves it to the left 10 pixels so it doesn't overlap
			chart
				.append("g")
				.attr("class", "axis y-axis")
				.attr("transform", "translate(-5, 0)")
				.call(yAxis);

			// Appends the yAxis
			chart
				.append("g")
				.attr("class", "axis x-axis")
				.attr("transform", "translate(0," + (height + 5) + ")")
				.call(xAxis);

			// Adds yAxis title
			chart
				.append("text")
				.text("Percent")
				.attr("transform", "translate(-30, -10)");

			chart
				.select(".x-axis")
				.selectAll("text")
				.attr("y", function(d, i) {
					if (i % 2 == 0) {
						return "10";
					} else {
						return "25";
					}
				});
		}

		// Update visualization country info
		function updateCountry(country) {
			//console.log(country);

			//console.log(country.name);
			if (country.name === "Kosovo") {
				var iso_a2 = "xk";
			} else {
				var iso_a2 = country.iso_a2.toLowerCase();
			}

			// Remove any current data
			$("#countryChart").empty();
			$("#countryHeader").empty();

			var countryName =
				"<h2 id='countryName' class='m-2 mt-2 text-center'></h2>";

			//console.log(countryName)

			$("#countryHeader").append(countryName);
			$("#countryName").text(country.name);

			//console.log("Current country");
			//console.log(currentCountry);

			var src = "svg/" + iso_a2 + ".svg";
			var img = "<img class='flag mx-auto shadow' src=" + src + " />";

			var countryFlag =
				"<div class='row'><div id='countryFlag' class='mx-auto mb-2'></div></div>";

			$("#countryHeader").append(countryFlag);
			$("#countryFlag").append(img);

			if (country[currentWave] != null) {
				var life =
					"<h5 class='life-time text-center'>Average life expectancy </h5><h6 class='life-time-data text-center'>" +
					country[currentWave]["life"] +
					" years</h6>";
				$("#countryChart").append(life);
				drawBarChart(country);
			} else {
				var message = "<h4 class='text-center'>No data available</h4>";
				$("#countryChart").append(message);
			}

			currentCountry = country;
		}

		// Remove country when deselected
		function removeCountry() {
			$("#countryHeader").empty();
			$("#countryChart").empty();
			currentCountry = null;
			//console.log("Current country");
			//console.log(currentCountry);
		}

		// When clicked on a country
		function clicked(d) {
			if (d && centered !== d) {
				centered = d;

				var country = world_id.filter(
					country => parseInt(country.id) == parseInt(d.id)
				);

				updateCountry(country[0]);
			} else {
				centered = null;
				removeCountry();
			}

			g.selectAll("path").classed(
				"active",
				centered &&
					function(d) {
						return d === centered;
					}
			);

			//console.log("Clicked");
			//console.log(d);

			var centroid = path.centroid(d),
				translate = projection.translate();

			//console.log(translate);
			//console.log(centroid);

			projection.translate([
				translate[0] - centroid[0] + width / 2,
				translate[1] - centroid[1] + height / 2
			]);

			zoom.translate(projection.translate());

			g.selectAll("path")
				.transition()
				.duration(900)
				.attr("d", path);
		}

		// D3 zoomed
		function zoomed() {
			//console.log("zoomed");
			projection.translate(d3.event.translate).scale(d3.event.scale);
			g.selectAll("path").attr("d", path);
		}
	</script>
</body>
